<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hand Magic by Ahmed Allam</title>
    
    <!-- استيراد خط سحري من Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Cinzel+Decorative:wght@700&display=swap" rel="stylesheet">

    <style>
        body { margin: 0; overflow: hidden; background-color: #000; font-family: 'Segoe UI', sans-serif; }
        
        /* الحاوية الرئيسية */
        #canvas-container { width: 100vw; height: 100vh; position: absolute; top: 0; left: 0; z-index: 1; }
        
        /* التوقيع السحري (أحمد علام) */
        #magic-title {
            position: absolute; top: 30px; left: 30px; z-index: 10;
            font-family: 'Cinzel Decorative', cursive;
            font-size: 28px; color: #fff;
            text-transform: uppercase;
            letter-spacing: 2px;
            pointer-events: none;
            /* تأثير التوهج السحري */
            text-shadow: 
                0 0 5px #fff,
                0 0 10px #fff,
                0 0 20px #00ffff,
                0 0 40px #00ffff,
                0 0 80px #00ffff;
            animation: textPulse 3s infinite alternate;
        }

        @keyframes textPulse {
            0% { opacity: 0.8; text-shadow: 0 0 10px #00ffff, 0 0 20px #00ffff; }
            100% { opacity: 1; text-shadow: 0 0 20px #ff00ff, 0 0 40px #ff00ff; }
        }

        /* الكاميرا */
        #cam-wrapper {
            position: absolute; bottom: 20px; left: 20px; 
            width: 160px; height: 120px; z-index: 5;
            border-radius: 15px; overflow: hidden;
            border: 2px solid rgba(255, 255, 255, 0.1);
            background: #000;
            box-shadow: 0 0 15px rgba(0,255,255,0.2);
        }
        #cam-preview { width: 100%; height: 100%; transform: scaleX(-1); opacity: 0.8; }
        #video-input { display: none; }
        
        /* شاشة التحميل */
        #loader {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            color: white; z-index: 20; text-align: center;
        }
    </style>
</head>
<body>

    <!-- التوقيع المطلوب -->
    <div id="magic-title">Hand magic by : Ahmed Allam</div>

    <div id="loader"><h2>جاري استدعاء السحر...</h2></div>
    
    <div id="cam-wrapper"><canvas id="cam-preview"></canvas></div>
    <video id="video-input"></video>
    <div id="canvas-container"></div>

    <!-- Libraries -->
    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/",
                "lil-gui": "https://unpkg.com/lil-gui@0.19.1/dist/lil-gui.esm.min.js"
            }
        }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        import GUI from 'lil-gui';

        // --- الإعدادات ---
        const config = {
            count: 35000,
            size: 0.09,
            shape: 'Galaxy Spiral',
            baseColor: '#00ffff', // اللون الافتراضي (سيان)
            autoRotate: true
        };

        let scene, camera, renderer, particles, geometry, material;
        let controls;
        let handState = { x: 0, y: 0, expansion: 1.0, detected: false };
        let smoothedRotX = 0, smoothedRotY = 0;

        initThree();
        initGUI();
        initMediaPipe();
        animate();

        function initThree() {
            const container = document.getElementById('canvas-container');
            
            scene = new THREE.Scene();
            scene.fog = new THREE.FogExp2(0x000000, 0.02);

            camera = new THREE.PerspectiveCamera(65, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.z = 15;

            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
            renderer.outputColorSpace = THREE.SRGBColorSpace;
            container.appendChild(renderer.domElement);

            controls = new OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.enableZoom = false; 
            controls.autoRotate = true;
            controls.autoRotateSpeed = 1.0;

            // خامة الجزيئات
            material = new THREE.PointsMaterial({
                size: config.size,
                map: createMagicTexture(),
                transparent: true,
                opacity: 0.85,
                blending: THREE.AdditiveBlending,
                depthWrite: false,
                vertexColors: true
            });

            generateShape(config.shape);
            window.addEventListener('resize', onWindowResize);
        }

        // --- 10 أشكال سحرية ---
        function generateShape(type) {
            if (particles) scene.remove(particles);

            const positions = [];
            const colors = [];
            const count = config.count;
            const userColor = new THREE.Color(config.baseColor); // لون المستخدم
            const tempColor = new THREE.Color();

            for (let i = 0; i < count; i++) {
                let x, y, z;
                let mixFactor = Math.random(); // لخلط الألوان

                // 1. Galaxy Spiral (مجرة حلزونية)
                if (type === 'Galaxy Spiral') {
                    const branches = 3;
                    const spin = i % branches;
                    const radius = Math.random() * 8;
                    const angle = spin * (Math.PI * 2 / branches) + radius * 0.8;
                    const randomOff = Math.random() - 0.5;
                    x = Math.cos(angle) * radius + randomOff;
                    y = (Math.random() - 0.5) * (radius * 0.2);
                    z = Math.sin(angle) * radius + randomOff;
                    tempColor.setHSL(0.6 + radius/20, 0.8, 0.6); // تدرج أزرق
                }
                // 2. DNA Helix (حمض نووي سحري)
                else if (type === 'DNA Helix') {
                    const t = (i / count) * 40; // طول الشريط
                    const radius = 3;
                    const strand = (i % 2 === 0) ? 0 : Math.PI; // شريطان
                    x = Math.cos(t + strand) * radius;
                    y = (t - 20) * 0.5; // ارتفاع
                    z = Math.sin(t + strand) * radius;
                    // تشتيت بسيط
                    x += (Math.random()-0.5); y += (Math.random()-0.5); z += (Math.random()-0.5);
                    tempColor.setHSL(i/count, 1.0, 0.6); // قوس قزح
                }
                // 3. Magic Cube (مكعب الطاقة)
                else if (type === 'Magic Cube') {
                    const side = 8;
                    x = (Math.random() - 0.5) * side;
                    y = (Math.random() - 0.5) * side;
                    z = (Math.random() - 0.5) * side;
                    // تكثيف الحواف
                    if (Math.random() > 0.8) {
                        const axis = Math.floor(Math.random()*3);
                        if(axis==0) x = Math.sign(x) * side * 0.5;
                        if(axis==1) y = Math.sign(y) * side * 0.5;
                        if(axis==2) z = Math.sign(z) * side * 0.5;
                    }
                    tempColor.setHSL(0.3, 1.0, 0.6); // أخضر نيون
                }
                // 4. Cosmic Heart (قلب كوني)
                else if (type === 'Cosmic Heart') {
                    const phi = Math.random() * Math.PI * 2;
                    const theta = Math.random() * Math.PI;
                    x = 16 * Math.pow(Math.sin(phi), 3);
                    y = 13 * Math.cos(phi) - 5 * Math.cos(2 * phi) - 2 * Math.cos(3 * phi) - Math.cos(4 * phi);
                    z = 4 * Math.cos(theta) * Math.sin(phi);
                    const scale = 0.35;
                    x *= scale; y *= scale; z *= scale;
                    tempColor.setHSL(0.95, 1.0, 0.6); // أحمر/وردي
                }
                // 5. Atomic Orbit (الذرة)
                else if (type === 'Atomic Orbit') {
                    const r = Math.random();
                    if (r < 0.2) { // النواة
                        const rad = 1.5 * Math.random();
                        const ang = Math.random() * Math.PI * 2;
                        const ang2 = Math.random() * Math.PI;
                        x = rad * Math.sin(ang2) * Math.cos(ang);
                        y = rad * Math.sin(ang2) * Math.sin(ang);
                        z = rad * Math.cos(ang2);
                    } else { // الإلكترونات
                        const ring = Math.floor(Math.random() * 3); // 3 مدارات
                        const ang = Math.random() * Math.PI * 2;
                        const rad = 6 + (Math.random()-0.5);
                        if (ring === 0) { x = Math.cos(ang)*rad; y = Math.sin(ang)*rad; z = 0; }
                        else if (ring === 1) { x = Math.cos(ang)*rad; z = Math.sin(ang)*rad; y = 0; }
                        else { y = Math.cos(ang)*rad; z = Math.sin(ang)*rad; x = 0; }
                        // تدوير المدارات
                         const rx = x; const ry = y; const rz = z;
                         if (ring===1) { x = rx * Math.cos(0.7) - ry * Math.sin(0.7); y = rx * Math.sin(0.7) + ry * Math.cos(0.7); }
                    }
                    tempColor.setHSL(0.55, 1.0, 0.7); // سيان
                }
                // 6. Black Hole (الثقب الأسود)
                else if (type === 'Black Hole') {
                    const angle = Math.random() * Math.PI * 2;
                    const rad = 4 + Math.random() * 6;
                    x = Math.cos(angle) * rad;
                    z = Math.sin(angle) * rad;
                    y = (Math.random()-0.5) * (12/rad); // أرفع عند الأطراف
                    const dist = Math.sqrt(x*x + z*z);
                    tempColor.setHSL(0.05 + dist/20, 1.0, 0.5); // برتقالي ناري
                }
                // 7. Tornado (إعصار)
                else if (type === 'Tornado') {
                    const h = (Math.random() - 0.5) * 15; // الارتفاع
                    const angle = i * 0.1;
                    const r = (h + 8) * 0.4 + Math.random(); 
                    x = Math.cos(angle) * r;
                    z = Math.sin(angle) * r;
                    y = h;
                    tempColor.setHSL(0.0, 0.0, 0.8); // أبيض رمادي
                }
                // 8. Hyper Sphere (كرة مشعة)
                else if (type === 'Hyper Sphere') {
                    const r = 5;
                    const theta = Math.random() * Math.PI * 2;
                    const phi = Math.acos(2 * Math.random() - 1);
                    x = r * Math.sin(phi) * Math.cos(theta);
                    y = r * Math.sin(phi) * Math.sin(theta);
                    z = r * Math.cos(phi);
                    // انفجار للخارج
                    x *= (1 + Math.random()*0.2); y *= (1 + Math.random()*0.2); z *= (1 + Math.random()*0.2);
                    tempColor.setHSL(Math.random(), 1.0, 0.7); // ألوان عشوائية
                }
                // 9. Hourglass (ساعة رملية)
                else if (type === 'Hourglass') {
                    const h = (Math.random() - 0.5) * 12;
                    const r = (Math.abs(h) + 1) * 0.6;
                    const ang = Math.random() * Math.PI * 2;
                    x = Math.cos(ang) * r;
                    z = Math.sin(ang) * r;
                    y = h;
                    tempColor.setHSL(0.12, 0.9, 0.6); // ذهبي
                }
                // 10. Star Field (حقل نجوم كلاسيكي)
                else if (type === 'Star Field') {
                    x = (Math.random() - 0.5) * 30;
                    y = (Math.random() - 0.5) * 30;
                    z = (Math.random() - 0.5) * 30;
                    tempColor.setHSL(0.6, 0.2, 0.9);
                }

                // دمج لون المستخدم مع لون الشكل الأصلي
                // نقوم بعمل Lerp (خلط) بنسبة 50%
                tempColor.lerp(userColor, 0.4);

                colors.push(tempColor.r, tempColor.g, tempColor.b);
                positions.push(x, y, z);
            }

            geometry = new THREE.BufferGeometry();
            geometry.setAttribute('position', new THREE.Float32BufferAttribute(positions, 3));
            geometry.setAttribute('color', new THREE.Float32BufferAttribute(colors, 3));
            geometry.userData.originalPositions = Float32Array.from(positions);

            particles = new THREE.Points(geometry, material);
            scene.add(particles);
        }

        // Texture
        function createMagicTexture() {
            const canvas = document.createElement('canvas');
            canvas.width = 32; canvas.height = 32;
            const ctx = canvas.getContext('2d');
            const g = ctx.createRadialGradient(16,16,0,16,16,16);
            g.addColorStop(0, 'rgba(255,255,255,1)');
            g.addColorStop(0.2, 'rgba(255,255,255,0.8)');
            g.addColorStop(0.5, 'rgba(255,255,255,0.2)');
            g.addColorStop(1, 'rgba(0,0,0,0)');
            ctx.fillStyle = g;
            ctx.fillRect(0,0,32,32);
            return new THREE.CanvasTexture(canvas);
        }

        function initGUI() {
            const gui = new GUI({ title: 'Magic Controls' });
            
            gui.add(config, 'shape', [
                'Galaxy Spiral', 'DNA Helix', 'Magic Cube', 'Cosmic Heart', 
                'Atomic Orbit', 'Black Hole', 'Tornado', 'Hyper Sphere', 
                'Hourglass', 'Star Field'
            ]).name('الشكل السحري').onChange(generateShape);

            gui.addColor(config, 'baseColor').name('لون السحر').onChange(() => generateShape(config.shape));
            gui.add(config, 'size', 0.01, 0.3).name('حجم الغبار').onChange(v => material.size = v);

            gui.domElement.style.top = '80px'; // تحريك القائمة للأسفل قليلاً
        }

        function initMediaPipe() {
            const video = document.getElementById('video-input');
            const canvas = document.getElementById('cam-preview');
            const ctx = canvas.getContext('2d');
            
            const hands = new Hands({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`});
            hands.setOptions({maxNumHands: 1, minDetectionConfidence: 0.5, minTrackingConfidence: 0.5});
            
            hands.onResults(res => {
                document.getElementById('loader').style.display = 'none';
                ctx.clearRect(0,0,canvas.width,canvas.height);
                ctx.drawImage(res.image, 0, 0, canvas.width, canvas.height);
                
                if(res.multiHandLandmarks.length > 0) {
                    handState.detected = true;
                    const lm = res.multiHandLandmarks[0];
                    drawConnectors(ctx, lm, HAND_CONNECTIONS, {color: '#00ffff', lineWidth: 2});
                    
                    // حساب الموقع للدوران
                    handState.x = (lm[9].x - 0.5) * 2; 
                    handState.y = (lm[9].y - 0.5) * 2;

                    // حساب التمدد
                    const dist = Math.hypot(lm[8].x - lm[4].x, lm[8].y - lm[4].y); // السبابة والابهام
                    const palm = Math.hypot(lm[0].x - lm[9].x, lm[0].y - lm[9].y);
                    handState.expansion = 0.5 + (dist/palm) * 2;
                } else {
                    handState.detected = false;
                }
            });

            const cam = new Camera(video, { onFrame: async () => await hands.send({image: video}), width: 320, height: 240 });
            cam.start();
        }

        function animate() {
            requestAnimationFrame(animate);
            
            const time = Date.now() * 0.0005;

            // Hand Logic
            if(handState.detected) {
                controls.autoRotate = false;
                smoothedRotX = THREE.MathUtils.lerp(smoothedRotX, handState.y, 0.1);
                smoothedRotY = THREE.MathUtils.lerp(smoothedRotY, handState.x * -1, 0.1); // عكس المحور ليكون طبيعياً
            } else {
                controls.autoRotate = true;
                smoothedRotX = THREE.MathUtils.lerp(smoothedRotX, 0, 0.05);
                smoothedRotY = THREE.MathUtils.lerp(smoothedRotY, 0, 0.05);
                // Breathe effect when idle
                handState.expansion = 1.0 + Math.sin(time) * 0.1;
            }

            if(particles) {
                particles.rotation.x = smoothedRotX;
                particles.rotation.y += 0.002 + smoothedRotY * 0.1;
                
                // Scale smooth
                particles.scale.setScalar(THREE.MathUtils.lerp(particles.scale.x, handState.expansion, 0.1));

                // Living particles
                const pos = particles.geometry.attributes.position.array;
                const orig = particles.geometry.userData.originalPositions;
                
                for(let i=0; i<config.count; i++) {
                    const idx = i*3;
                    // تموج مستمر
                    pos[idx+1] = orig[idx+1] + Math.sin(time + orig[idx]*0.5) * 0.15;
                }
                particles.geometry.attributes.position.needsUpdate = true;
            }

            controls.update();
            renderer.render(scene, camera);
        }
        
        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }
    </script>
</body>
</html>
