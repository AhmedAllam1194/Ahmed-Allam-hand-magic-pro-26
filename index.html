<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>COSMIC ARTIFACT - Ahmed Allam</title>
    
    <!-- Cinematic Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Cinzel+Decorative:wght@700;900&family=Montserrat:wght@300;600&display=swap" rel="stylesheet">

    <style>
        /* إعدادات الصفحة الأساسية */
        body { margin: 0; overflow: hidden; background-color: #010103; font-family: 'Montserrat', sans-serif; user-select: none; }
        
        #canvas-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; }

        /* واجهة المستخدم العلوية */
        #header-ui {
            position: absolute; top: 30px; width: 100%; text-align: center; pointer-events: none; z-index: 10;
        }
        h1 {
            font-family: 'Cinzel Decorative', cursive; font-size: 3.5rem; color: #fff; margin: 0;
            text-shadow: 0 0 30px rgba(100, 200, 255, 0.8), 0 0 60px rgba(200, 0, 255, 0.6); 
            letter-spacing: 6px; opacity: 0; animation: fadeIn 2s forwards 0.5s;
        }
        .subtitle {
            font-size: 1rem; color: #ccf; letter-spacing: 4px; text-transform: uppercase;
            margin-top: 5px; opacity: 0; animation: fadeIn 2s forwards 1s;
        }

        /* نافذة الكاميرا (أسفل اليمين) */
        #cam-wrapper {
            position: absolute; bottom: 30px; right: 30px;
            width: 240px; height: 160px; z-index: 20;
            border-radius: 12px; overflow: hidden;
            border: 2px solid rgba(0, 255, 255, 0.4);
            background: #000; box-shadow: 0 0 40px rgba(0, 255, 255, 0.2);
            opacity: 0; transition: opacity 1s;
        }
        #video-input { 
            width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); 
            opacity: 0.8; filter: contrast(1.3) hue-rotate(180deg); /* تأثير فضائي للكاميرا */
        }
        
        /* النصوص الساحرة */
        #status-msg {
            position: absolute; bottom: 50px; left: 50%; transform: translateX(-50%);
            color: rgba(200, 240, 255, 0.9); font-size: 16px; letter-spacing: 2px;
            text-shadow: 0 0 15px rgba(0, 255, 255, 0.6); pointer-events: none; z-index: 10;
            font-weight: 600;
        }

        /* شاشة البدء */
        #start-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle at center, #1a0b2e 0%, #000000 100%); z-index: 100;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
        #start-btn {
            background: linear-gradient(90deg, #ff00cc, #3333ff);
            border: none; padding: 20px 60px; color: white; font-size: 1.4rem;
            font-family: 'Cinzel Decorative', cursive; border-radius: 50px; 
            cursor: pointer; box-shadow: 0 0 40px rgba(255, 0, 204, 0.5);
            transition: transform 0.3s, box-shadow 0.3s;
            text-transform: uppercase; letter-spacing: 2px;
        }
        #start-btn:hover { transform: scale(1.1); box-shadow: 0 0 70px rgba(50, 50, 255, 0.8); }
        
        @keyframes fadeIn { to { opacity: 1; } }
    </style>
</head>
<body>

    <!-- زر البدء -->
    <div id="start-screen">
        <h1 style="font-size: 50px; opacity: 1; margin-bottom: 40px;">COSMIC ARTIFACT</h1>
        <button id="start-btn">SUMMON THE MAGIC</button>
        <div style="margin-top: 30px; color: #88a; font-size: 12px; letter-spacing: 3px;">DESIGNED BY AHMED ALLAM</div>
    </div>

    <!-- واجهة اللعبة -->
    <div id="header-ui">
        <h1>COSMIC ARTIFACT</h1>
        <div class="subtitle">Magical Hand Control</div>
    </div>

    <div id="status-msg">Awaiting Cosmic Connection...</div>

    <div id="cam-wrapper">
        <video id="video-input" playsinline></video>
    </div>

    <div id="canvas-container"></div>

    <!-- مكتبات Three.js و MediaPipe -->
    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
            }
        }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>

    <script type="module">
        import * as THREE from 'three';
        import { EffectComposer } from 'three/addons/postprocessing/EffectComposer.js';
        import { RenderPass } from 'three/addons/postprocessing/RenderPass.js';
        import { UnrealBloomPass } from 'three/addons/postprocessing/UnrealBloomPass.js';
        import { OutputPass } from 'three/addons/postprocessing/OutputPass.js';

        // --- إعدادات الفيزياء ---
        const PHYSICS = {
            lerpFactor: 0.05,   // حركة ثقيلة وفخمة
            scaleLerp: 0.04,    
            rotationSpeed: 0.12, 
            idleSpeed: 0.002
        };

        const state = {
            detected: false,
            targetPos: new THREE.Vector3(),
            currentPos: new THREE.Vector3(),
            targetScale: 1,
            currentScale: 0,
            rotVelocity: new THREE.Vector2(),
            time: 0
        };

        // --- تهيئة المشهد ---
        const container = document.getElementById('canvas-container');
        const scene = new THREE.Scene();
        scene.fog = new THREE.FogExp2(0x050510, 0.02); // ضباب بنفسجي غامق

        const camera = new THREE.PerspectiveCamera(50, window.innerWidth / window.innerHeight, 0.1, 100);
        camera.position.z = 14;

        const renderer = new THREE.WebGLRenderer({ antialias: false, powerPreference: "high-performance" });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
        renderer.toneMapping = THREE.ACESFilmicToneMapping;
        container.appendChild(renderer.domElement);

        // --- Post Processing (توهج قوي) ---
        const composer = new EffectComposer(renderer);
        const renderPass = new RenderPass(scene, camera);
        // توهج قوي جداً للسحر
        const bloomPass = new UnrealBloomPass(new THREE.Vector2(window.innerWidth, window.innerHeight), 2.0, 0.5, 0.9);
        bloomPass.threshold = 0.1;
        bloomPass.strength = 1.8; 
        bloomPass.radius = 0.8;
        
        composer.addPass(renderPass);
        composer.addPass(bloomPass);
        composer.addPass(new OutputPass());

        // --- الإضاءة ---
        const ambientLight = new THREE.AmbientLight(0x222244, 1.0);
        scene.add(ambientLight);

        // أضواء ملونة
        const pLight1 = new THREE.PointLight(0xff00cc, 2, 20); // وردي
        pLight1.position.set(5, 5, 5);
        scene.add(pLight1);

        const pLight2 = new THREE.PointLight(0x00ffff, 2, 20); // سماوي
        pLight2.position.set(-5, -5, 5);
        scene.add(pLight2);

        // --- بناء المجسم السحري (The Artifact) ---
        const artifactGroup = new THREE.Group();
        
        // 1. النواة السحرية (Plasma Core)
        const coreGeo = new THREE.IcosahedronGeometry(1.5, 4); // كرة مضلعة
        const coreMat = new THREE.MeshStandardMaterial({
            color: 0xffffff,
            emissive: 0x5500ff,
            emissiveIntensity: 0.5,
            roughness: 0.2,
            metalness: 0.9,
            wireframe: false
        });
        const core = new THREE.Mesh(coreGeo, coreMat);
        artifactGroup.add(core);

        // 2. القفص الخارجي (Energy Cage) - Wireframe
        const cageGeo = new THREE.IcosahedronGeometry(2.2, 1);
        const cageMat = new THREE.MeshBasicMaterial({
            color: 0x00ffff,
            wireframe: true,
            transparent: true,
            opacity: 0.3
        });
        const cage = new THREE.Mesh(cageGeo, cageMat);
        artifactGroup.add(cage);

        // 3. الحلقات الجيروسكوبية (Gyro Rings)
        const ringGeo = new THREE.TorusGeometry(3.0, 0.05, 16, 100);
        const ringMat = new THREE.MeshBasicMaterial({ color: 0xff00aa, transparent: true, opacity: 0.6 });
        
        const ring1 = new THREE.Mesh(ringGeo, ringMat);
        const ring2 = new THREE.Mesh(ringGeo, ringMat);
        const ring3 = new THREE.Mesh(ringGeo, ringMat);

        ring2.rotation.x = Math.PI / 2;
        ring3.rotation.y = Math.PI / 2;

        artifactGroup.add(ring1);
        artifactGroup.add(ring2);
        artifactGroup.add(ring3);

        // 4. جزيئات عائمة حول المجسم (Orbiting Particles)
        const particlesGeo = new THREE.BufferGeometry();
        const pCount = 200;
        const pPos = new Float32Array(pCount * 3);
        for(let i=0; i<pCount*3; i+=3) {
            const r = 4 + Math.random() * 2;
            const theta = Math.random() * Math.PI * 2;
            const phi = Math.acos(2 * Math.random() - 1);
            pPos[i] = r * Math.sin(phi) * Math.cos(theta);
            pPos[i+1] = r * Math.sin(phi) * Math.sin(theta);
            pPos[i+2] = r * Math.cos(phi);
        }
        particlesGeo.setAttribute('position', new THREE.BufferAttribute(pPos, 3));
        const particlesMat = new THREE.PointsMaterial({color: 0xffdd00, size: 0.08});
        const orbitParticles = new THREE.Points(particlesGeo, particlesMat);
        artifactGroup.add(orbitParticles);

        scene.add(artifactGroup);

        // --- الخلفية الكونية (Nebula Galaxy) ---
        const starGeo = new THREE.BufferGeometry();
        const starCount = 4000;
        const starPos = new Float32Array(starCount * 3);
        const starColors = new Float32Array(starCount * 3);
        const colorPalette = [new THREE.Color(0x00ffff), new THREE.Color(0xff00ff), new THREE.Color(0xffffff)];

        for(let i=0; i<starCount; i++) {
            const i3 = i*3;
            starPos[i3] = (Math.random() - 0.5) * 100;
            starPos[i3+1] = (Math.random() - 0.5) * 100;
            starPos[i3+2] = (Math.random() - 0.5) * 80 - 20;

            const col = colorPalette[Math.floor(Math.random() * colorPalette.length)];
            starColors[i3] = col.r;
            starColors[i3+1] = col.g;
            starColors[i3+2] = col.b;
        }
        starGeo.setAttribute('position', new THREE.BufferAttribute(starPos, 3));
        starGeo.setAttribute('color', new THREE.BufferAttribute(starColors, 3));
        
        const starMat = new THREE.PointsMaterial({
            vertexColors: true, 
            size: 0.1, 
            transparent: true, 
            opacity: 0.8,
            blending: THREE.AdditiveBlending
        });
        const stars = new THREE.Points(starGeo, starMat);
        scene.add(stars);

        // --- حلقة التحريك ---
        const clock = new THREE.Clock();

        function animate() {
            requestAnimationFrame(animate);
            const delta = clock.getDelta();
            const time = clock.getElapsedTime();
            state.time = time;

            // 1. تحريك أجزاء المجسم تلقائياً (Animation)
            // النواة تنبض
            const pulse = 1 + Math.sin(time * 3) * 0.1;
            core.scale.setScalar(pulse);
            core.material.emissiveIntensity = 0.5 + Math.sin(time * 5) * 0.3;

            // الأقفاص والحلقات تدور
            cage.rotation.y -= 0.01;
            cage.rotation.z += 0.005;
            
            ring1.rotation.x += 0.02;
            ring2.rotation.y += 0.02;
            ring3.rotation.z += 0.02;

            orbitParticles.rotation.y += 0.005;

            // 2. فيزياء التحكم باليد
            if (state.detected) {
                // تتبع اليد بنعومة فائقة
                state.currentPos.lerp(state.targetPos, PHYSICS.lerpFactor);
                state.currentScale = THREE.MathUtils.lerp(state.currentScale, state.targetScale, PHYSICS.scaleLerp);

                document.getElementById('status-msg').innerText = "Artifact Stabilized | Magic Active";
                document.getElementById('status-msg').style.color = "#00ffff";
                document.getElementById('status-msg').style.textShadow = "0 0 20px #00ffff";
            } else {
                // العودة للوسط
                state.currentPos.lerp(new THREE.Vector3(0,0,0), 0.03);
                state.currentScale = THREE.MathUtils.lerp(state.currentScale, 1.0, 0.03);
                
                // دوران كامل للمجموعة عند السكون
                artifactGroup.rotation.y += PHYSICS.idleSpeed;
                artifactGroup.rotation.z = Math.sin(time * 0.5) * 0.1; // أرجحة خفيفة

                document.getElementById('status-msg').innerText = "Waiting for Sorcerer...";
                document.getElementById('status-msg').style.color = "#ccf";
                document.getElementById('status-msg').style.textShadow = "none";
            }

            // تطبيق الموقع والحجم
            artifactGroup.position.copy(state.currentPos);
            artifactGroup.scale.setScalar(state.currentScale);
            
            // تطبيق الدوران اليدوي
            artifactGroup.rotation.y += state.rotVelocity.x;
            artifactGroup.rotation.x += state.rotVelocity.y;
            
            // احتكاك لتقليل السرعة تدريجياً
            state.rotVelocity.multiplyScalar(0.96);

            // تحريك النجوم في الخلفية (Parallax)
            stars.rotation.z += 0.0005;

            composer.render();
        }

        // --- MediaPipe Logic ---
        const videoElement = document.getElementById('video-input');
        const startBtn = document.getElementById('start-btn');
        const startScreen = document.getElementById('start-screen');
        const camWrapper = document.getElementById('cam-wrapper');

        startBtn.addEventListener('click', async () => {
            startBtn.innerText = "CHARGING SPELLS...";
            startBtn.style.background = "#333";
            
            const hands = new Hands({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`});
            
            hands.setOptions({
                maxNumHands: 2,
                modelComplexity: 1,
                minDetectionConfidence: 0.6,
                minTrackingConfidence: 0.6
            });

            hands.onResults(onHandsResults);

            const cameraUtils = new Camera(videoElement, {
                onFrame: async () => { await hands.send({image: videoElement}); },
                width: 640, height: 480
            });

            await cameraUtils.start();
            
            startScreen.style.opacity = 0;
            setTimeout(() => { startScreen.style.display = 'none'; }, 1000);
            camWrapper.style.opacity = 1;
            
            animate();
        });

        function onHandsResults(results) {
            if (results.multiHandLandmarks && results.multiHandLandmarks.length === 2) {
                state.detected = true;
                
                const hand1 = results.multiHandLandmarks[0][9]; 
                const hand2 = results.multiHandLandmarks[1][9];

                // تحويل الإحداثيات
                const h1x = (1 - hand1.x) * 10 - 5; 
                const h1y = -(hand1.y * 8 - 4);
                const h2x = (1 - hand2.x) * 10 - 5;
                const h2y = -(hand2.y * 8 - 4);

                // المركز
                const cx = (h1x + h2x) / 2;
                const cy = (h1y + h2y) / 2;
                state.targetPos.set(cx, cy, 0);

                // المسافة للتحجيم
                const dist = Math.sqrt(Math.pow(h2x - h1x, 2) + Math.pow(h2y - h1y, 2));
                // معادلة التكبير: كلما زادت المسافة كبر المجسم
                state.targetScale = THREE.MathUtils.clamp(dist * 0.35, 0.4, 2.8);

                // الدوران بناء على حركة المركز
                const dx = state.targetPos.x - state.currentPos.x;
                const dy = state.targetPos.y - state.currentPos.y;
                
                state.rotVelocity.x += dx * 0.008; 
                state.rotVelocity.y -= dy * 0.008; 

            } else {
                state.detected = false;
            }
        }

        // --- Resize ---
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
            composer.setSize(window.innerWidth, window.innerHeight);
        });

    </script>
</body>
</html>
