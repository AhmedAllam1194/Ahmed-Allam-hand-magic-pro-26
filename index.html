<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Magic Hand - Ahmed Allam</title>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Cinzel+Decorative:wght@700;900&family=Montserrat:wght@300;600&display=swap" rel="stylesheet">

    <style>
        body { margin: 0; overflow: hidden; background-color: #000; font-family: 'Montserrat', sans-serif; user-select: none; }
        
        #canvas-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; }

        /* العناوين */
        #header-ui {
            position: absolute; top: 30px; width: 100%; text-align: center; pointer-events: none; z-index: 10;
        }
        h1 {
            font-family: 'Cinzel Decorative', cursive; font-size: 2.5rem; color: #fff; margin: 0;
            text-shadow: 0 0 20px rgba(0, 255, 255, 0.8); letter-spacing: 3px;
        }
        .subtitle {
            font-size: 1rem; color: #aaa; letter-spacing: 2px; text-transform: uppercase; margin-top: 5px;
        }

        /* نافذة الكاميرا */
        #cam-wrapper {
            position: absolute; bottom: 20px; right: 20px;
            width: 200px; height: 150px; z-index: 20;
            border-radius: 15px; overflow: hidden;
            border: 2px solid rgba(255, 255, 255, 0.2);
            background: #000; box-shadow: 0 0 30px rgba(0,0,0,0.5);
        }
        #video-input { 
            width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); opacity: 0.7;
        }

        /* حالة النظام */
        #status-msg {
            position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%);
            color: #fff; font-size: 14px; background: rgba(0,0,0,0.6);
            padding: 10px 20px; border-radius: 20px; border: 1px solid #444; z-index: 10;
        }

        /* زر البدء */
        #start-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(10, 10, 20, 0.95); z-index: 100;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
        #start-btn {
            background: linear-gradient(90deg, #00c6ff, #0072ff);
            border: none; padding: 15px 50px; color: white; font-size: 1.5rem;
            font-family: 'Cinzel Decorative', cursive; border-radius: 50px; 
            cursor: pointer; box-shadow: 0 0 30px rgba(0, 114, 255, 0.6);
            transition: transform 0.2s;
        }
        #start-btn:hover { transform: scale(1.1); }
    </style>
</head>
<body>

    <!-- Start Screen -->
    <div id="start-screen">
        <h1 style="font-size: 40px; margin-bottom: 20px;">MAGIC HAND</h1>
        <button id="start-btn">START EXPERIENCE</button>
        <div style="margin-top: 15px; color: #888;">created by Ahmed Allam</div>
    </div>

    <!-- UI -->
    <div id="header-ui">
        <h1>MAGIC HAND</h1>
        <div class="subtitle">created by Ahmed Allam</div>
    </div>

    <div id="status-msg">Click START to enable magic...</div>

    <div id="cam-wrapper">
        <video id="video-input" playsinline></video>
    </div>

    <div id="canvas-container"></div>

    <!-- Libraries -->
    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/",
                "lil-gui": "https://unpkg.com/lil-gui@0.19.1/dist/lil-gui.esm.min.js"
            }
        }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>

    <script type="module">
        import * as THREE from 'three';
        import { EffectComposer } from 'three/addons/postprocessing/EffectComposer.js';
        import { RenderPass } from 'three/addons/postprocessing/RenderPass.js';
        import { UnrealBloomPass } from 'three/addons/postprocessing/UnrealBloomPass.js';
        import { OutputPass } from 'three/addons/postprocessing/OutputPass.js';
        import GUI from 'lil-gui';

        // --- Configuration ---
        const CONFIG = {
            smoothness: 0.1,
            rotationSpeed: 2.0,
            glowStrength: 1.5,
            objectType: 'Cosmic Artifact', // Default
            baseColor: '#00ffff'
        };

        const state = {
            handsDetected: 0, // 0, 1, or 2
            targetPos: new THREE.Vector3(),
            currentPos: new THREE.Vector3(),
            targetScale: 1,
            currentScale: 0,
            targetRot: { x: 0, y: 0 },
            currentRot: { x: 0, y: 0 }
        };

        // --- Three.js Init ---
        const container = document.getElementById('canvas-container');
        const scene = new THREE.Scene();
        scene.fog = new THREE.FogExp2(0x050505, 0.02);

        const camera = new THREE.PerspectiveCamera(50, window.innerWidth / window.innerHeight, 0.1, 100);
        camera.position.z = 12;

        const renderer = new THREE.WebGLRenderer({ antialias: false });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
        renderer.toneMapping = THREE.ACESFilmicToneMapping;
        container.appendChild(renderer.domElement);

        // --- Post Processing ---
        const composer = new EffectComposer(renderer);
        const renderPass = new RenderPass(scene, camera);
        const bloomPass = new UnrealBloomPass(new THREE.Vector2(window.innerWidth, window.innerHeight), 1.5, 0.4, 0.85);
        bloomPass.threshold = 0.1;
        bloomPass.strength = CONFIG.glowStrength;
        bloomPass.radius = 0.5;
        
        composer.addPass(renderPass);
        composer.addPass(bloomPass);
        composer.addPass(new OutputPass());

        // --- Lighting ---
        const ambientLight = new THREE.AmbientLight(0x404040);
        scene.add(ambientLight);
        const dirLight = new THREE.DirectionalLight(0xffffff, 2);
        dirLight.position.set(5, 5, 5);
        scene.add(dirLight);
        
        // Interactive Light
        const magicLight = new THREE.PointLight(CONFIG.baseColor, 0, 10);
        scene.add(magicLight);

        // --- Objects Manager ---
        let currentMesh = new THREE.Group();
        scene.add(currentMesh);

        function createCosmicArtifact() {
            const group = new THREE.Group();
            
            // Core
            const coreGeo = new THREE.IcosahedronGeometry(1.5, 2);
            const coreMat = new THREE.MeshStandardMaterial({ 
                color: CONFIG.baseColor, emissive: CONFIG.baseColor, emissiveIntensity: 0.5,
                roughness: 0.1, metalness: 0.9, wireframe: false 
            });
            const core = new THREE.Mesh(coreGeo, coreMat);
            group.add(core);

            // Rings
            const ringGeo = new THREE.TorusGeometry(2.5, 0.05, 16, 100);
            const ringMat = new THREE.MeshBasicMaterial({ color: 0xffffff, transparent: true, opacity: 0.5 });
            const r1 = new THREE.Mesh(ringGeo, ringMat);
            const r2 = new THREE.Mesh(ringGeo, ringMat); r2.rotation.x = Math.PI/2;
            const r3 = new THREE.Mesh(ringGeo, ringMat); r3.rotation.y = Math.PI/2;
            
            group.add(r1, r2, r3);
            return group;
        }

        function createSaturn() {
            const group = new THREE.Group();
            const planetGeo = new THREE.SphereGeometry(1.5, 32, 32);
            const planetMat = new THREE.MeshStandardMaterial({ color: 0xccaa88, roughness: 0.5 });
            const planet = new THREE.Mesh(planetGeo, planetMat);
            group.add(planet);

            const ringGeo = new THREE.RingGeometry(2.0, 3.5, 64);
            const ringMat = new THREE.MeshBasicMaterial({ color: 0xaa8866, side: THREE.DoubleSide, transparent: true, opacity: 0.8 });
            const ring = new THREE.Mesh(ringGeo, ringMat);
            ring.rotation.x = Math.PI / 1.8;
            group.add(ring);
            return group;
        }

        function createMagicSun() {
            const group = new THREE.Group();
            const geo = new THREE.SphereGeometry(1.8, 32, 32);
            const mat = new THREE.MeshStandardMaterial({ 
                color: 0xffaa00, emissive: 0xff4400, emissiveIntensity: 1, wireframe: true
            });
            const sun = new THREE.Mesh(geo, mat);
            group.add(sun);
            return group;
        }

        function switchObject(type) {
            scene.remove(currentMesh);
            if (type === 'Cosmic Artifact') currentMesh = createCosmicArtifact();
            else if (type === 'Saturn') currentMesh = createSaturn();
            else if (type === 'Magic Sun') currentMesh = createMagicSun();
            scene.add(currentMesh);
        }

        // Initialize with default
        switchObject(CONFIG.objectType);

        // --- GUI Menu ---
        function initGUI() {
            const gui = new GUI({ title: 'Magic Controls' });
            
            gui.add(CONFIG, 'objectType', ['Cosmic Artifact', 'Saturn', 'Magic Sun'])
               .name('Select Object')
               .onChange(val => switchObject(val));
            
            gui.addColor(CONFIG, 'baseColor')
               .name('Magic Color')
               .onChange(val => {
                   magicLight.color.set(val);
                   // Update existing materials if possible
                   switchObject(CONFIG.objectType); 
               });

            gui.add(bloomPass, 'strength', 0, 3).name('Glow Strength');
            
            gui.domElement.style.marginTop = '60px';
        }

        // --- Background Stars ---
        const starGeo = new THREE.BufferGeometry();
        const starPos = [];
        for(let i=0; i<3000; i++) {
            starPos.push((Math.random()-0.5)*100, (Math.random()-0.5)*100, (Math.random()-0.5)*50 - 20);
        }
        starGeo.setAttribute('position', new THREE.Float32BufferAttribute(starPos, 3));
        const stars = new THREE.Points(starGeo, new THREE.PointsMaterial({size: 0.05, color: 0xffffff}));
        scene.add(stars);

        // --- Animation Loop ---
        function animate() {
            requestAnimationFrame(animate);

            // Physics Smoothing (Lerp)
            state.currentPos.lerp(state.targetPos, CONFIG.smoothness);
            state.currentScale = THREE.MathUtils.lerp(state.currentScale, state.targetScale, CONFIG.smoothness);
            
            // Rotation Smoothing
            state.currentRot.x = THREE.MathUtils.lerp(state.currentRot.x, state.targetRot.x, CONFIG.smoothness);
            state.currentRot.y = THREE.MathUtils.lerp(state.currentRot.y, state.targetRot.y, CONFIG.smoothness);

            // Apply Transforms
            currentMesh.position.copy(state.currentPos);
            currentMesh.scale.setScalar(state.currentScale);
            
            // Apply Hand Rotation + Idle Rotation
            currentMesh.rotation.x = state.currentRot.x + 0.3; // Tilt
            currentMesh.rotation.y = state.currentRot.y + (performance.now() * 0.0005); 

            // Floating Effect
            currentMesh.position.y += Math.sin(performance.now() * 0.001) * 0.05;

            // Magic Light Interaction
            magicLight.position.copy(state.currentPos);
            magicLight.intensity = state.handsDetected > 0 ? 2 : 0;

            composer.render();
        }

        // --- MediaPipe Hand Tracking ---
        const videoElement = document.getElementById('video-input');
        const startBtn = document.getElementById('start-btn');
        const startScreen = document.getElementById('start-screen');
        const statusMsg = document.getElementById('status-msg');

        startBtn.addEventListener('click', async () => {
            startBtn.innerText = "LOADING AI...";
            initGUI();
            
            const hands = new Hands({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`});
            
            hands.setOptions({
                maxNumHands: 2,
                modelComplexity: 1,
                minDetectionConfidence: 0.5,
                minTrackingConfidence: 0.5
            });

            hands.onResults(onHandsResults);

            const cameraUtils = new Camera(videoElement, {
                onFrame: async () => { await hands.send({image: videoElement}); },
                width: 640, height: 480
            });

            await cameraUtils.start();
            
            startScreen.style.display = 'none';
            statusMsg.innerText = "Hands Active | 1 Hand: Move/Rotate | 2 Hands: Zoom";
            animate();
        });

        function onHandsResults(results) {
            const landmarks = results.multiHandLandmarks;
            
            if (landmarks && landmarks.length > 0) {
                state.handsDetected = landmarks.length;
                
                // 1. Position & Rotation (Based on first hand or center of two)
                let cx, cy;
                
                if (landmarks.length === 1) {
                    const lm = landmarks[0];
                    cx = (1 - lm[9].x) * 10 - 5;
                    cy = -(lm[9].y * 8 - 4);
                    
                    // Rotation control using single hand movement relative to center
                    state.targetRot.y = (lm[9].x - 0.5) * CONFIG.rotationSpeed * -2;
                    state.targetRot.x = (lm[9].y - 0.5) * CONFIG.rotationSpeed * -2;
                    
                    state.targetScale = 1.2; // Default size for 1 hand

                } else if (landmarks.length === 2) {
                    const h1 = landmarks[0][9];
                    const h2 = landmarks[1][9];
                    
                    // Center point
                    const rawCx = (h1.x + h2.x) / 2;
                    const rawCy = (h1.y + h2.y) / 2;
                    
                    cx = (1 - rawCx) * 10 - 5;
                    cy = -(rawCy * 8 - 4);

                    // Scale logic (Distance between hands)
                    const dist = Math.hypot(h1.x - h2.x, h1.y - h2.y);
                    state.targetScale = Math.max(0.5, Math.min(3.0, dist * 4));
                }

                state.targetPos.set(cx, cy, 0);

            } else {
                state.handsDetected = 0;
                // Reset to idle
                state.targetPos.set(0, 0, 0);
                state.targetScale = 1;
                state.targetRot.x = 0;
                state.targetRot.y = 0;
            }
        }

        // Resize
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
            composer.setSize(window.innerWidth, window.innerHeight);
        });

    </script>
</body>
</html>
