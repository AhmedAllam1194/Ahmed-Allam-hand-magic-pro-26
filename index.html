<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hand Magic by Ahmed Allam (Fixed)</title>
    <!-- خطوط سحرية -->
    <link href="https://fonts.googleapis.com/css2?family=Cinzel+Decorative:wght@700&display=swap" rel="stylesheet">
    <style>
        body { margin: 0; overflow: hidden; background-color: #000; font-family: sans-serif; }
        #canvas-container { width: 100vw; height: 100vh; position: absolute; top: 0; left: 0; z-index: 1; }
        
        /* رسائل الخطأ */
        #error-msg {
            display: none; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: rgba(255,0,0,0.8); color: white; padding: 20px; border-radius: 10px; z-index: 100;
            text-align: center; direction: rtl; max-width: 80%;
        }

        #magic-title {
            position: absolute; top: 20px; left: 20px; z-index: 10;
            font-family: 'Cinzel Decorative', cursive; font-size: 24px; color: #fff;
            text-shadow: 0 0 10px #00ffff; pointer-events: none;
        }

        #loader {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            color: #00ffff; font-size: 20px; z-index: 20; text-align: center;
            background: rgba(0,0,0,0.7); padding: 20px; border-radius: 15px;
        }
        
        #cam-preview {
            position: absolute; bottom: 20px; left: 20px; width: 160px; height: 120px;
            z-index: 5; border: 2px solid #333; background: #000; transform: scaleX(-1);
            border-radius: 10px;
        }
        #video-input { display: none; }
    </style>
</head>
<body>

    <div id="magic-title">Hand magic by : Ahmed Allam</div>
    <div id="error-msg"></div>
    <div id="loader">
        <h2>جاري تهيئة النظام...</h2>
        <p>1. يرجى الموافقة على الكاميرا<br>2. تأكد أنك لا تفتح الملف مباشرة (file://)</p>
    </div>
    
    <canvas id="cam-preview"></canvas>
    <video id="video-input" playsinline></video>
    <div id="canvas-container"></div>

    <!-- 1. استيراد المكتبات بنسخ محددة (Pinned Versions) لتجنب الأخطاء -->
    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/",
                "lil-gui": "https://unpkg.com/lil-gui@0.19.1/dist/lil-gui.esm.min.js"
            }
        }
    </script>

    <!-- MediaPipe Libraries (Global) -->
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands@0.4.1646424915/hands.js" crossorigin="anonymous"></script>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        import GUI from 'lil-gui';

        // --- التعامل مع الأخطاء ---
        function showError(msg) {
            const el = document.getElementById('error-msg');
            el.style.display = 'block';
            el.innerHTML = `<h3>⚠️ تنبيه</h3><p>${msg}</p>`;
            document.getElementById('loader').style.display = 'none';
        }

        window.onerror = function(message, source, lineno, colno, error) {
            console.error(error);
            // تجاهل أخطاء WebGL التحذيرية، عرض الأخطاء الجسيمة فقط
            if(message.includes("Uncaught")) 
                showError("حدث خطأ برمجي: " + message + "<br>تأكد من اتصال الإنترنت لتحميل المكتبات.");
        };

        // --- الإعدادات ---
        const config = {
            count: 30000, size: 0.1, shape: 'Galaxy Spiral', baseColor: '#00ffff', autoRotate: true
        };

        let scene, camera, renderer, particles, material, controls;
        let handState = { x: 0, y: 0, expansion: 1.0, detected: false };
        let smoothedRotX = 0, smoothedRotY = 0;

        try {
            initThree();
            initGUI();
            initMediaPipe();
            animate();
        } catch (e) {
            showError("لم يتمكن المتصفح من تشغيل WebGL. <br>" + e.message);
        }

        function initThree() {
            const container = document.getElementById('canvas-container');
            scene = new THREE.Scene();
            scene.fog = new THREE.FogExp2(0x000000, 0.02);

            camera = new THREE.PerspectiveCamera(65, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.z = 15;

            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
            renderer.outputColorSpace = THREE.SRGBColorSpace;
            container.appendChild(renderer.domElement);

            controls = new OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true; 
            controls.enableZoom = false;
            controls.autoRotate = true;

            material = new THREE.PointsMaterial({
                size: config.size,
                map: createMagicTexture(),
                transparent: true, opacity: 0.8, blending: THREE.AdditiveBlending,
                depthWrite: false, vertexColors: true
            });

            generateShape(config.shape);
            window.addEventListener('resize', () => {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            });
        }

        function generateShape(type) {
            if (particles) scene.remove(particles);
            const positions = [], colors = [];
            const colorObj = new THREE.Color(config.baseColor);
            const tempColor = new THREE.Color();

            for (let i = 0; i < config.count; i++) {
                let x, y, z;
                // أشكال مبسطة ومضمونة
                if (type === 'Galaxy Spiral') {
                    const angle = i * 0.005; 
                    const r = i * 0.0005 * 10; 
                    x = r * Math.cos(angle * 5) + (Math.random()-0.5);
                    y = (Math.random()-0.5) * 2;
                    z = r * Math.sin(angle * 5) + (Math.random()-0.5);
                    tempColor.setHSL(i/config.count, 0.8, 0.6);
                } else if (type === 'Magic Sphere') {
                    const r = 6;
                    const theta = Math.random() * Math.PI * 2;
                    const phi = Math.acos(2 * Math.random() - 1);
                    x = r * Math.sin(phi) * Math.cos(theta);
                    y = r * Math.sin(phi) * Math.sin(theta);
                    z = r * Math.cos(phi);
                    tempColor.setHSL(Math.random(), 1.0, 0.6);
                } else {
                    // Random Cloud default
                    x = (Math.random()-0.5)*20; y = (Math.random()-0.5)*20; z = (Math.random()-0.5)*20;
                    tempColor.set(config.baseColor);
                }
                
                tempColor.lerp(colorObj, 0.3);
                positions.push(x, y, z);
                colors.push(tempColor.r, tempColor.g, tempColor.b);
            }

            const geometry = new THREE.BufferGeometry();
            geometry.setAttribute('position', new THREE.Float32BufferAttribute(positions, 3));
            geometry.setAttribute('color', new THREE.Float32BufferAttribute(colors, 3));
            geometry.userData.originalPositions = Float32Array.from(positions);
            particles = new THREE.Points(geometry, material);
            scene.add(particles);
        }

        function createMagicTexture() {
            const cvs = document.createElement('canvas');
            cvs.width = 32; cvs.height = 32;
            const ctx = cvs.getContext('2d');
            const g = ctx.createRadialGradient(16,16,0,16,16,16);
            g.addColorStop(0,'rgba(255,255,255,1)');
            g.addColorStop(1,'rgba(0,0,0,0)');
            ctx.fillStyle = g; ctx.fillRect(0,0,32,32);
            return new THREE.CanvasTexture(cvs);
        }

        function initMediaPipe() {
            if (window.location.protocol === 'file:') {
                showError("⚠️ خطأ أمني: لا يمكن تشغيل الكاميرا من الملف مباشرة.<br>الحل: استخدم Live Server في VS Code.");
                return;
            }

            const video = document.getElementById('video-input');
            const canvas = document.getElementById('cam-preview');
            const ctx = canvas.getContext('2d');

            const hands = new Hands({locateFile: (file) => {
                return `https://cdn.jsdelivr.net/npm/@mediapipe/hands@0.4.1646424915/${file}`;
            }});

            hands.setOptions({maxNumHands: 1, modelComplexity: 1, minDetectionConfidence: 0.5, minTrackingConfidence: 0.5});

            hands.onResults(res => {
                document.getElementById('loader').style.display = 'none';
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.drawImage(res.image, 0, 0, canvas.width, canvas.height);
                
                if (res.multiHandLandmarks.length > 0) {
                    handState.detected = true;
                    const lm = res.multiHandLandmarks[0];
                    drawConnectors(ctx, lm, HAND_CONNECTIONS, {color: '#00ffff'});
                    
                    // Logic
                    handState.x = (lm[9].x - 0.5) * 2;
                    handState.y = (lm[9].y - 0.5) * 2;
                    const d = Math.hypot(lm[8].x - lm[4].x, lm[8].y - lm[4].y);
                    handState.expansion = 0.5 + d * 5; 
                } else {
                    handState.detected = false;
                }
            });

            const cameraUtils = new Camera(video, {
                onFrame: async () => { await hands.send({image: video}); },
                width: 320, height: 240
            });
            
            cameraUtils.start().catch(err => {
                showError("فشل تشغيل الكاميرا. تأكد من السماح للمتصفح باستخدام الكاميرا.");
                console.error(err);
            });
        }

        function initGUI() {
            const gui = new GUI({ title: 'Magic Panel' });
            gui.add(config, 'shape', ['Galaxy Spiral', 'Magic Sphere', 'Cloud']).onChange(generateShape);
            gui.addColor(config, 'baseColor').onChange(() => generateShape(config.shape));
            gui.domElement.style.top = '60px';
        }

        function animate() {
            requestAnimationFrame(animate);
            
            if(handState.detected) {
                controls.autoRotate = false;
                smoothedRotX = THREE.MathUtils.lerp(smoothedRotX, handState.y, 0.1);
                smoothedRotY = THREE.MathUtils.lerp(smoothedRotY, -handState.x, 0.1);
                particles.rotation.x = smoothedRotX;
                particles.rotation.y += smoothedRotY * 0.1;
                
                const targetScale = Math.min(Math.max(handState.expansion, 0.2), 3.0);
                particles.scale.setScalar(THREE.MathUtils.lerp(particles.scale.x, targetScale, 0.1));
            } else {
                controls.autoRotate = true;
                particles.rotation.y += 0.001;
                // تنفس
                particles.scale.setScalar(1.0 + Math.sin(Date.now()*0.001)*0.1);
            }
            
            controls.update();
            renderer.render(scene, camera);
        }
    </script>
</body>
</html>
