<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Magic Planet Control - Ahmed Allam</title>
    
    <!-- خطوط سينمائية -->
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700&family=Tajawal:wght@400;700&display=swap" rel="stylesheet">

    <style>
        body { margin: 0; overflow: hidden; background-color: #000; font-family: 'Tajawal', sans-serif; user-select: none; }
        
        /* واجهة المستخدم */
        #ui-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: 10;
        }

        /* العنوان */
        #header {
            position: absolute; top: 30px; width: 100%; text-align: center;
        }
        h1 {
            font-family: 'Cinzel', serif; font-size: 3rem; color: #fff; margin: 0;
            text-shadow: 0 0 20px rgba(0, 150, 255, 0.8);
            letter-spacing: 5px;
        }
        .subtitle {
            font-size: 1rem; color: #aaa; letter-spacing: 2px; text-transform: uppercase;
        }

        /* تعليمات الحالة */
        #status-text {
            position: absolute; bottom: 40px; left: 50%; transform: translateX(-50%);
            font-size: 1.2rem; color: #fff; text-shadow: 0 0 10px #000;
            background: rgba(0,0,0,0.5); padding: 10px 30px; border-radius: 30px;
            border: 1px solid rgba(255,255,255,0.2); transition: all 0.3s;
        }

        /* الكاميرا */
        #cam-wrapper {
            position: absolute; bottom: 30px; right: 30px;
            width: 200px; height: 150px;
            border-radius: 15px; overflow: hidden;
            border: 2px solid rgba(0, 255, 255, 0.3);
            background: #000; box-shadow: 0 0 20px rgba(0,255,255,0.1);
        }
        #video-input { 
            width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); opacity: 0.6;
        }

        /* زر البدء */
        #start-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 100;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
        #start-btn {
            background: linear-gradient(45deg, #00aaff, #0044ff);
            border: none; padding: 20px 60px; color: white; font-size: 1.5rem;
            border-radius: 50px; cursor: pointer; font-family: 'Tajawal', sans-serif;
            box-shadow: 0 0 30px rgba(0, 100, 255, 0.6);
            transition: transform 0.2s;
        }
        #start-btn:hover { transform: scale(1.1); }
    </style>
</head>
<body>

    <!-- شاشة البداية -->
    <div id="start-overlay">
        <h1 style="margin-bottom: 20px;">التحكم السحري بالكواكب</h1>
        <button id="start-btn">ابدأ التجربة</button>
        <p style="color: #666; margin-top: 15px;">By: Ahmed Allam</p>
    </div>

    <!-- الواجهة -->
    <div id="ui-layer">
        <div id="header">
            <h1>PLANET MASTER</h1>
            <div class="subtitle">Hand Magic by Ahmed Allam</div>
        </div>
        <div id="status-text">بانتظار اليد...</div>
        <div id="cam-wrapper">
            <video id="video-input" playsinline></video>
        </div>
    </div>

    <div id="canvas-container"></div>

    <!-- المكتبات -->
    <script type="importmap">
        { "imports": { "three": "https://unpkg.com/three@0.160.0/build/three.module.js", "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/" } }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>

    <script type="module">
        import * as THREE from 'three';
        import { UnrealBloomPass } from 'three/addons/postprocessing/UnrealBloomPass.js';
        import { EffectComposer } from 'three/addons/postprocessing/EffectComposer.js';
        import { RenderPass } from 'three/addons/postprocessing/RenderPass.js';
        import { OutputPass } from 'three/addons/postprocessing/OutputPass.js';

        // --- الإعدادات ---
        const CONFIG = {
            smooth: 0.1,      // نعومة الحركة
            rotationSpeed: 3.5, // سرعة الدوران باليد
            minScale: 0.6,    // الحجم عند القبضة
            maxScale: 2.2     // الحجم عند فتح اليد
        };

        const state = {
            handDetected: false,
            handOpenness: 1.0, // 0 = fist, 1 = open
            handX: 0, handY: 0,
            targetScale: 1.0,
            targetRotX: 0, targetRotY: 0
        };

        let scene, camera, renderer, composer;
        let earth, atmosphere, clouds;
        let starField;

        // --- تهيئة المشهد ---
        function init() {
            const container = document.getElementById('canvas-container');
            
            scene = new THREE.Scene();
            scene.fog = new THREE.FogExp2(0x000000, 0.02);

            camera = new THREE.PerspectiveCamera(50, window.innerWidth / window.innerHeight, 0.1, 100);
            camera.position.z = 10;

            renderer = new THREE.WebGLRenderer({ antialias: false }); // Antialias off for post-processing
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
            renderer.toneMapping = THREE.ACESFilmicToneMapping;
            container.appendChild(renderer.domElement);

            // Post Processing (Bloom)
            const renderScene = new RenderPass(scene, camera);
            const bloomPass = new UnrealBloomPass(new THREE.Vector2(window.innerWidth, window.innerHeight), 1.5, 0.4, 0.85);
            bloomPass.threshold = 0.1; bloomPass.strength = 1.2; bloomPass.radius = 0.5;
            
            composer = new EffectComposer(renderer);
            composer.addPass(renderScene);
            composer.addPass(bloomPass);
            composer.addPass(new OutputPass());

            // إضاءة
            const sunLight = new THREE.DirectionalLight(0xffffff, 2.5);
            sunLight.position.set(5, 3, 5);
            scene.add(sunLight);
            
            const ambient = new THREE.AmbientLight(0x333333);
            scene.add(ambient);

            // إضافة الأرض
            createEarth();
            createStars();

            window.addEventListener('resize', onResize);
            animate();
        }

        function createEarth() {
            const earthGroup = new THREE.Group();

            // 1. الكوكب (Textures from robust CDNs)
            const loader = new THREE.TextureLoader();
            
            const geo = new THREE.SphereGeometry(2, 64, 64);
            const mat = new THREE.MeshStandardMaterial({
                map: loader.load('https://unpkg.com/three-globe/example/img/earth-blue-marble.jpg'),
                bumpMap: loader.load('https://unpkg.com/three-globe/example/img/earth-topology.png'),
                bumpScale: 0.05,
                roughness: 0.6,
                metalness: 0.1
            });
            earth = new THREE.Mesh(geo, mat);
            earthGroup.add(earth);

            // 2. الغيوم
            const cloudGeo = new THREE.SphereGeometry(2.03, 64, 64);
            const cloudMat = new THREE.MeshStandardMaterial({
                map: loader.load('https://unpkg.com/three-globe/example/img/earth-clouds.png'),
                transparent: true, opacity: 0.8, blending: THREE.AdditiveBlending, side: THREE.DoubleSide
            });
            clouds = new THREE.Mesh(cloudGeo, cloudMat);
            earthGroup.add(clouds);

            // 3. الغلاف الجوي (Atmosphere Glow)
            const atmoGeo = new THREE.SphereGeometry(2.2, 64, 64);
            const atmoMat = new THREE.MeshBasicMaterial({
                color: 0x00aaff, transparent: true, opacity: 0.3, blending: THREE.AdditiveBlending, side: THREE.BackSide
            });
            atmosphere = new THREE.Mesh(atmoGeo, atmoMat);
            earthGroup.add(atmosphere);

            scene.add(earthGroup);
            
            // حفظ المرجع للدوران
            state.planetObj = earthGroup;
        }

        function createStars() {
            const geo = new THREE.BufferGeometry();
            const pos = [];
            for(let i=0; i<3000; i++) {
                pos.push((Math.random()-0.5)*100, (Math.random()-0.5)*100, (Math.random()-0.5)*50 - 20);
            }
            geo.setAttribute('position', new THREE.Float32BufferAttribute(pos, 3));
            const mat = new THREE.PointsMaterial({color: 0xffffff, size: 0.05, transparent: true, opacity: 0.8});
            starField = new THREE.Points(geo, mat);
            scene.add(starField);
        }

        // --- حلقة التحريك والفيزياء ---
        function animate() {
            requestAnimationFrame(animate);

            if (state.handDetected) {
                // 1. التحكم بالحجم (Open vs Fist)
                // Linear Interpolation for smooth resizing
                const targetS = THREE.MathUtils.lerp(CONFIG.minScale, CONFIG.maxScale, state.handOpenness);
                const currentS = state.planetObj.scale.x;
                const smoothS = THREE.MathUtils.lerp(currentS, targetS, CONFIG.smooth);
                state.planetObj.scale.setScalar(smoothS);

                // تغيير لون الغلاف الجوي حسب الحالة
                // يد مفتوحة = أزرق (طاقة)، قبضة = أحمر (ضغط)
                const colorTarget = new THREE.Color().setHSL(state.handOpenness > 0.5 ? 0.6 : 0.0, 1.0, 0.5);
                atmosphere.material.color.lerp(colorTarget, 0.1);

                // 2. التحكم بالدوران (Rotation 360)
                // نحسب الفرق بين موضع اليد ومركز الشاشة
                const rotX = state.handY * CONFIG.rotationSpeed; // Pitch
                const rotY = state.handX * CONFIG.rotationSpeed; // Yaw
                
                // نعومة الدوران
                state.planetObj.rotation.x = THREE.MathUtils.lerp(state.planetObj.rotation.x, rotX, CONFIG.smooth);
                state.planetObj.rotation.y = THREE.MathUtils.lerp(state.planetObj.rotation.y, rotY, CONFIG.smooth);

                // نص الحالة
                const status = document.getElementById('status-text');
                if (state.handOpenness < 0.3) {
                    status.innerText = "قبضة: انكماش";
                    status.style.borderColor = "#ff0000";
                } else {
                    status.innerText = "كف مفتوح: تمدد";
                    status.style.borderColor = "#00aaff";
                }

            } else {
                // دوران تلقائي عند عدم وجود يد
                state.planetObj.rotation.y += 0.002;
                // عودة للحجم الطبيعي
                const s = THREE.MathUtils.lerp(state.planetObj.scale.x, 1, 0.05);
                state.planetObj.scale.setScalar(s);
                atmosphere.material.color.lerp(new THREE.Color(0x00aaff), 0.05);
                document.getElementById('status-text').innerText = "بانتظار اليد...";
                document.getElementById('status-text').style.borderColor = "#ffffff";
            }

            // حركة الغيوم المستمرة
            clouds.rotation.y += 0.0005;

            composer.render();
        }

        // --- MediaPipe ---
        function initMediaPipe() {
            const video = document.getElementById('video-input');
            const hands = new Hands({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`});
            
            hands.setOptions({
                maxNumHands: 1,
                modelComplexity: 1,
                minDetectionConfidence: 0.7,
                minTrackingConfidence: 0.7
            });

            hands.onResults(onResults);

            const cameraUtils = new Camera(video, {
                onFrame: async () => { await hands.send({image: video}); },
                width: 320, height: 240
            });
            
            cameraUtils.start();
        }

        function onResults(results) {
            if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
                state.handDetected = true;
                const lm = results.multiHandLandmarks[0];

                // 1. حساب موضع اليد (للدوران)
                // النقطة 9 هي منتصف الكف
                // تحويل الإحداثيات من 0-1 إلى -1 إلى 1
                state.handX = (1 - lm[9].x) * 2 - 1; 
                state.handY = (lm[9].y * 2 - 1); 

                // 2. حساب الانفتاح (Openness) للتكبير
                // المسافة بين المعصم (0) ورأس الوسطى (12)
                const wrist = lm[0];
                const tip = lm[12];
                const base = lm[0]; // المعصم كنقطة مرجعية
                
                // حساب المسافة الإقليدية
                const distance = Math.sqrt(Math.pow(tip.x - wrist.x, 2) + Math.pow(tip.y - wrist.y, 2));
                
                // معايرة المسافة (تقريباً 0.1 للقبضة و 0.4 لليد المفتوحة)
                // نحولها لقيمة بين 0 و 1
                let openVal = (distance - 0.15) * 3.5;
                state.handOpenness = Math.max(0, Math.min(1, openVal));

            } else {
                state.handDetected = false;
            }
        }

        function onResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
            composer.setSize(window.innerWidth, window.innerHeight);
        }

        // تشغيل
        document.getElementById('start-btn').addEventListener('click', () => {
            document.getElementById('start-overlay').style.display = 'none';
            init();
            initMediaPipe();
        });

    </script>
</body>
</html>
