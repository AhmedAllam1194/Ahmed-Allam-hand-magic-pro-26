<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Magical Universe - Ahmed Allam</title>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel+Decorative:wght@900&display=swap" rel="stylesheet">
    <style>
        body { margin: 0; overflow: hidden; background-color: #000; font-family: sans-serif; }
        
        /* شاشة تشخيص الأخطاء (تظهر فقط عند المشاكل) */
        #debug-console {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); color: #ff5555; z-index: 9999;
            padding: 40px; box-sizing: border-box; display: none;
            font-family: monospace; direction: ltr; overflow: auto; text-align: left;
        }
        #debug-console h1 { color: white; border-bottom: 1px solid #555; padding-bottom: 10px; }

        /* التصميم الأساسي */
        #magic-title {
            position: absolute; top: 20px; left: 20px; z-index: 10;
            font-family: 'Cinzel Decorative', cursive; pointer-events: none;
        }
        .main-title {
            font-size: 30px; display: block;
            background: linear-gradient(90deg, #fff, #0ff, #f0f);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            filter: drop-shadow(0 0 10px #0ff);
        }
        .sub-title { font-size: 14px; color: #ccc; letter-spacing: 2px; display: block; }
        
        #loading {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%,-50%);
            color: #0ff; text-align: center; font-size: 18px; z-index: 5;
        }
        
        #cam-preview {
            position: absolute; bottom: 20px; left: 20px; width: 150px; height: 110px;
            border: 2px solid #333; border-radius: 10px; transform: scaleX(-1);
            background: #000; z-index: 5;
        }
        #video-input { display: none; }
    </style>
</head>
<body>

    <!-- شاشة عرض الأخطاء -->
    <div id="debug-console">
        <h1>System Diagnostics / تشخيص النظام</h1>
        <p id="debug-text"></p>
        <button onclick="location.reload()" style="padding:10px; background:#333; color:white; border:none; cursor:pointer; margin-top:20px;">Reload Page</button>
    </div>

    <div id="magic-title">
        <span class="main-title">Hand Magic</span>
        <span class="sub-title">By : Ahmed Allam</span>
    </div>

    <div id="loading">جاري تحميل النظام...<br>يرجى الانتظار</div>
    <canvas id="cam-preview"></canvas>
    <video id="video-input" playsinline></video>
    <div id="canvas-container"></div>

    <!-- استيراد المكتبات -->
    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/",
                "lil-gui": "https://unpkg.com/lil-gui@0.19.1/dist/lil-gui.esm.min.js"
            }
        }
    </script>

    <!-- MediaPipe Global -->
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        import GUI from 'lil-gui';

        // --- نظام التقاط الأخطاء ---
        function logError(msg) {
            const consoleDiv = document.getElementById('debug-console');
            const textDiv = document.getElementById('debug-text');
            consoleDiv.style.display = 'block';
            textDiv.innerHTML += `<span style="color:red;">[ERROR]</span> ${msg}<br><br>`;
            document.getElementById('loading').style.display = 'none';
        }

        window.onerror = function(msg, source, lineno, colno, error) {
            logError(`Script Error: ${msg}`);
            return false;
        };

        // التحقق من تشغيل الملف مباشرة
        if (window.location.protocol === 'file:') {
            logError("FATAL ERROR: You are running this file via 'file://'.<br>خطأ قاتل: لا يمكن تشغيل الكاميرا من الملف مباشرة.<br>Solution: Use VS Code Live Server or CodePen.io.");
            throw new Error("File Protocol Block");
        }

        const config = { count: 35000, size: 0.08, shape: 'Earth' };
        let scene, camera, renderer, particles, material, controls;
        let handState = { x: 0, y: 0, expansion: 1.0, detected: false };
        let smooth = { x: 0, y: 0 };

        try {
            initThree();
            initGUI();
            initMediaPipe();
            animate();
        } catch (e) {
            logError(e.message);
        }

        function initThree() {
            const container = document.getElementById('canvas-container');
            if(!container) throw new Error("Canvas container not found");

            scene = new THREE.Scene();
            scene.fog = new THREE.FogExp2(0x000000, 0.02);

            camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.z = 16;

            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
            renderer.outputColorSpace = THREE.SRGBColorSpace;
            container.appendChild(renderer.domElement);

            controls = new OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true; controls.enableZoom = false; controls.autoRotate = true;

            material = new THREE.PointsMaterial({
                size: config.size,
                map: createTexture(),
                transparent: true, opacity: 0.9, blending: THREE.AdditiveBlending,
                depthWrite: false, vertexColors: true
            });

            generateShape(config.shape);
            window.addEventListener('resize', () => {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            });
        }

        function generateShape(type) {
            if (particles) scene.remove(particles);
            const positions = [], colors = [];
            const color = new THREE.Color();

            for (let i = 0; i < config.count; i++) {
                let x, y, z;
                // Basic Sphere logic
                const r = 5;
                const theta = Math.random() * Math.PI * 2;
                const phi = Math.acos(2 * Math.random() - 1);
                x = r * Math.sin(phi) * Math.cos(theta);
                y = r * Math.sin(phi) * Math.sin(theta);
                z = r * Math.cos(phi);

                if (type === 'Earth') {
                    const noise = Math.sin(x*0.5) * Math.cos(y*0.5);
                    if(Math.abs(y)>4.5) color.setHSL(0.6,0.1,0.9); // Polar
                    else if(noise>0.2) color.setHSL(0.3,0.6,0.3); // Land
                    else color.setHSL(0.6,0.8,0.4); // Ocean
                } else if (type === 'Sun') {
                    x*=1.2; y*=1.2; z*=1.2;
                    color.setHSL(0.05 + Math.random()*0.1, 1.0, 0.6);
                } else if (type === 'Galaxy') {
                     const arms = 3;
                     const spin = i % arms;
                     const rad = Math.random() * 10;
                     const ang = spin * (Math.PI*2/arms) + rad * 0.5;
                     x = Math.cos(ang)*rad + (Math.random()-0.5);
                     z = Math.sin(ang)*rad + (Math.random()-0.5);
                     y = (Math.random()-0.5);
                     color.setHSL(0.6 + rad/20, 0.8, 0.6);
                } else {
                    // Default Planets
                    color.setHSL(Math.random(), 0.8, 0.5);
                }
                
                positions.push(x, y, z);
                colors.push(color.r, color.g, color.b);
            }

            const geo = new THREE.BufferGeometry();
            geo.setAttribute('position', new THREE.Float32BufferAttribute(positions, 3));
            geo.setAttribute('color', new THREE.Float32BufferAttribute(colors, 3));
            geo.userData.original = Float32Array.from(positions);
            particles = new THREE.Points(geo, material);
            scene.add(particles);
        }

        function createTexture() {
            const c = document.createElement('canvas'); c.width=32; c.height=32;
            const ctx = c.getContext('2d');
            const g = ctx.createRadialGradient(16,16,0,16,16,16);
            g.addColorStop(0,'rgba(255,255,255,1)');
            g.addColorStop(1,'rgba(0,0,0,0)');
            ctx.fillStyle=g; ctx.fillRect(0,0,32,32);
            return new THREE.CanvasTexture(c);
        }

        function initMediaPipe() {
            const video = document.getElementById('video-input');
            const canvas = document.getElementById('cam-preview');
            const ctx = canvas.getContext('2d');

            const hands = new Hands({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`});
            hands.setOptions({maxNumHands: 1, minDetectionConfidence: 0.5, minTrackingConfidence: 0.5});

            hands.onResults(res => {
                document.getElementById('loading').style.display = 'none';
                ctx.clearRect(0,0,canvas.width,canvas.height);
                ctx.drawImage(res.image, 0, 0, canvas.width, canvas.height);
                if(res.multiHandLandmarks.length > 0) {
                    handState.detected = true;
                    const lm = res.multiHandLandmarks[0];
                    drawConnectors(ctx, lm, HAND_CONNECTIONS, {color: '#0ff'});
                    handState.x = (lm[9].x - 0.5) * 2;
                    handState.y = (lm[9].y - 0.5) * 2;
                    const d = Math.hypot(lm[8].x - lm[4].x, lm[8].y - lm[4].y);
                    handState.expansion = 0.5 + d * 5;
                } else {
                    handState.detected = false;
                }
            });

            const cam = new Camera(video, {
                onFrame: async () => { await hands.send({image: video}); },
                width: 320, height: 240
            });
            cam.start().catch(e => logError("Camera Access Denied: " + e.message));
        }

        function initGUI() {
            const gui = new GUI({ title: 'Planets' });
            gui.add(config, 'shape', ['Earth', 'Sun', 'Galaxy', 'Mars', 'Jupiter']).onChange(generateShape);
            gui.domElement.style.top = '100px';
        }

        function animate() {
            requestAnimationFrame(animate);
            if(handState.detected) {
                controls.autoRotate = false;
                smooth.x = THREE.MathUtils.lerp(smooth.x, handState.y, 0.1);
                smooth.y = THREE.MathUtils.lerp(smooth.y, -handState.x, 0.1);
                particles.rotation.x = smooth.x;
                particles.rotation.y += smooth.y * 0.1;
                particles.scale.setScalar(THREE.MathUtils.lerp(particles.scale.x, handState.expansion, 0.1));
            } else {
                controls.autoRotate = true;
                particles.scale.setScalar(1 + Math.sin(Date.now()*0.001)*0.05);
            }
            controls.update();
            renderer.render(scene, camera);
        }
    </script>
</body>
</html>
