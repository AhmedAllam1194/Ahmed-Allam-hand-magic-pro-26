<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MAGIC HAND - Cinematic Experience</title>
    
    <!-- Typography: Cinematic & Arabic -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Amiri:ital,wght@1,400;1,700&family=Cinzel:wght@400;700&family=Montserrat:wght@300;600&display=swap" rel="stylesheet">

    <style>
        /* CORE UI SETUP */
        body { margin: 0; overflow: hidden; background-color: #050508; font-family: 'Montserrat', sans-serif; }
        
        #canvas-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; }
        
        /* UI OVERLAY LAYER */
        #ui-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 10; pointer-events: none;
            display: flex; flex-direction: column; justify-content: space-between; align-items: center;
        }

        /* TOP TITLES */
        .header { margin-top: 40px; text-align: center; text-shadow: 0 0 20px rgba(255,255,255,0.2); }
        h1 {
            font-family: 'Cinzel', serif; font-size: 3rem; color: #f0f0f5; letter-spacing: 0.5rem;
            margin: 0; font-weight: 400; opacity: 0; animation: fadeDown 2s ease-out forwards 0.5s;
        }
        .subtitle {
            font-size: 0.9rem; color: #8888aa; letter-spacing: 0.2rem; text-transform: uppercase;
            margin-top: 10px; opacity: 0; animation: fadeUp 2s ease-out forwards 1s;
        }

        /* ARABIC ATMOSPHERIC TEXT */
        #arabic-overlay {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            font-family: 'Amiri', serif; font-size: 2.5rem; color: rgba(255, 255, 255, 0.85);
            text-align: center; width: 100%; pointer-events: none;
            text-shadow: 0 0 15px rgba(100, 200, 255, 0.4);
            opacity: 0; transition: opacity 1.5s ease-in-out;
        }

        /* CAMERA FEED (Bottom Center) */
        #cam-wrapper {
            margin-bottom: 30px; width: 200px; height: 120px;
            border: 1px solid rgba(255,255,255,0.15); border-radius: 12px;
            overflow: hidden; opacity: 0; animation: fadeUp 2s ease-out forwards 1.5s;
            box-shadow: 0 0 30px rgba(0,0,0,0.8); backdrop-filter: blur(5px);
            position: relative;
        }
        #video-input { 
            width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); 
            opacity: 0.6; filter: grayscale(100%) contrast(1.2);
        }
        .cam-label {
            position: absolute; bottom: 5px; left: 0; width: 100%; text-align: center;
            font-size: 9px; color: rgba(255,255,255,0.4); letter-spacing: 2px;
        }

        /* LOADING */
        #loader {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            color: #fff; letter-spacing: 4px; font-size: 12px; z-index: 20;
        }

        @keyframes fadeDown { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes fadeUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <!-- UI STRUCTURE -->
    <div id="ui-layer">
        <div class="header">
            <h1>MAGIC HAND</h1>
            <div class="subtitle">Created by Ahmed Allam</div>
        </div>

        <div id="arabic-overlay"></div>

        <div id="cam-wrapper">
            <video id="video-input" playsinline></video>
            <div class="cam-label">SENSOR ACTIVE</div>
        </div>
    </div>

    <div id="loader">INITIALIZING COSMOS...</div>
    <div id="canvas-container"></div>

    <!-- MODULES -->
    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
            }
        }
    </script>
    <!-- MediaPipe -->
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>

    <script type="module">
        import * as THREE from 'three';
        import { EffectComposer } from 'three/addons/postprocessing/EffectComposer.js';
        import { RenderPass } from 'three/addons/postprocessing/RenderPass.js';
        import { UnrealBloomPass } from 'three/addons/postprocessing/UnrealBloomPass.js';
        import { OutputPass } from 'three/addons/postprocessing/OutputPass.js';

        // --- CONFIGURATION ---
        const CONFIG = {
            smoothFactor: 0.08,    // Lower = heavier feel
            rotationSmooth: 0.05,
            scaleSmooth: 0.05,
            friction: 0.98,        // Inertia decay
            minScale: 0.8,
            maxScale: 2.5,
            idleAnimSpeed: 0.002
        };

        const ARABIC_PHRASES = [
            "دخول عالم سحر المجرة",
            "لمسة تحرّك الفضاء",
            "إحساس الحركة في الفراغ",
            "حين تلتقي اليد بالطاقة",
            "تجربة لمس الكواكب"
        ];

        // --- STATE MANAGEMENT ---
        const state = {
            handsDetected: false,
            targetPos: new THREE.Vector3(),
            currentPos: new THREE.Vector3(),
            velocity: new THREE.Vector3(),
            
            targetRotZ: 0,
            currentRotZ: 0,
            
            targetScale: 1,
            currentScale: 0, // Starts at 0 to pop in

            planetIndex: 0,
            lastPhraseTime: 0,
            phraseIndex: 0
        };

        // --- SCENE SETUP ---
        const container = document.getElementById('canvas-container');
        const scene = new THREE.Scene();
        scene.fog = new THREE.FogExp2(0x020205, 0.015); // Deep space fog

        const camera = new THREE.PerspectiveCamera(50, window.innerWidth / window.innerHeight, 0.1, 100);
        camera.position.set(0, 0, 12);

        const renderer = new THREE.WebGLRenderer({ antialias: false, powerPreference: "high-performance" });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
        renderer.toneMapping = THREE.ACESFilmicToneMapping;
        renderer.toneMappingExposure = 1.2;
        container.appendChild(renderer.domElement);

        // --- POST PROCESSING (BLOOM) ---
        const renderScene = new RenderPass(scene, camera);
        const bloomPass = new UnrealBloomPass(new THREE.Vector2(window.innerWidth, window.innerHeight), 1.5, 0.4, 0.85);
        bloomPass.threshold = 0.2;
        bloomPass.strength = 1.2;
        bloomPass.radius = 0.5;
        
        const outputPass = new OutputPass();
        const composer = new EffectComposer(renderer);
        composer.addPass(renderScene);
        composer.addPass(bloomPass);
        composer.addPass(outputPass);

        // --- LIGHTING ---
        const ambientLight = new THREE.AmbientLight(0x404060, 0.5);
        scene.add(ambientLight);

        const mainLight = new THREE.DirectionalLight(0xfff0dd, 2);
        mainLight.position.set(10, 10, 10);
        scene.add(mainLight);

        const handLight = new THREE.PointLight(0x00aaff, 0, 10); // Interactive light
        scene.add(handLight);

        // --- PLANET GENERATION (PROCEDURAL) ---
        
        // 1. SATURN (Procedural Shader)
        function createSaturn() {
            const group = new THREE.Group();
            
            // Body
            const geometry = new THREE.SphereGeometry(1.5, 64, 64);
            const material = new THREE.MeshStandardMaterial({
                color: 0xccaa88,
                roughness: 0.6,
                metalness: 0.1,
            });
            const planet = new THREE.Mesh(geometry, material);
            group.add(planet);

            // Rings
            const ringGeo = new THREE.RingGeometry(2.0, 3.5, 128);
            var pos = ringGeo.attributes.position;
            var v3 = new THREE.Vector3();
            for (let i = 0; i < pos.count; i++){
                v3.fromBufferAttribute(pos, i);
                ringGeo.attributes.uv.setXY(i, v3.length() < 2.8 ? 0 : 1, 1);
            }
            
            const ringMat = new THREE.MeshStandardMaterial({
                color: 0xaa8866,
                side: THREE.DoubleSide,
                transparent: true,
                opacity: 0.8,
                roughness: 0.8
            });
            const ring = new THREE.Mesh(ringGeo, ringMat);
            ring.rotation.x = Math.PI / 2;
            group.add(ring);

            return group;
        }

        const activePlanet = createSaturn();
        scene.add(activePlanet);

        // --- BACKGROUND STARS ---
        const starGeo = new THREE.BufferGeometry();
        const starCount = 2000;
        const starPos = new Float32Array(starCount * 3);
        for(let i=0; i<starCount*3; i++) {
            starPos[i] = (Math.random() - 0.5) * 60;
        }
        starGeo.setAttribute('position', new THREE.BufferAttribute(starPos, 3));
        const starMat = new THREE.PointsMaterial({color: 0xffffff, size: 0.05, transparent: true, opacity: 0.8});
        const stars = new THREE.Points(starGeo, starMat);
        scene.add(stars);


        // --- PHYSICS & INTERACTION LOOP ---
        
        function updatePhysics() {
            // 1. POSITION (Spring/Lerp)
            if (state.handsDetected) {
                // Move towards hands
                state.currentPos.lerp(state.targetPos, CONFIG.smoothFactor);
                
                // Calculate simulated velocity for inertia later
                state.velocity.copy(state.targetPos).sub(state.currentPos).multiplyScalar(0.1);
                
                // Rotation (Steering Wheel logic)
                state.currentRotZ = THREE.MathUtils.lerp(state.currentRotZ, state.targetRotZ, CONFIG.rotationSmooth);
                
                // Scale (Breathing)
                state.currentScale = THREE.MathUtils.lerp(state.currentScale, state.targetScale, CONFIG.scaleSmooth);
                
                // Interactive Light
                handLight.intensity = THREE.MathUtils.lerp(handLight.intensity, 2, 0.1);
                handLight.position.copy(state.currentPos);
                handLight.position.z += 2;

            } else {
                // INERTIA MODE (Floating away)
                state.currentPos.add(state.velocity);
                state.velocity.multiplyScalar(CONFIG.friction); // Apply drag
                
                // Return to idle scale
                state.currentScale = THREE.MathUtils.lerp(state.currentScale, 0.8, 0.02);
                
                // Idle Rotation
                activePlanet.rotation.y += CONFIG.idleAnimSpeed;
                
                // Dim light
                handLight.intensity = THREE.MathUtils.lerp(handLight.intensity, 0, 0.05);
            }

            // Apply transforms to object
            activePlanet.position.copy(state.currentPos);
            activePlanet.scale.setScalar(state.currentScale);
            
            // Apply Z rotation (tilting) plus constant idle spin
            activePlanet.rotation.z = state.currentRotZ;
            activePlanet.rotation.x = 0.3; // Default tilt
            
            // Subtle "Alive" Bobbing
            const time = performance.now() * 0.001;
            activePlanet.position.y += Math.sin(time) * 0.005;
        }

        // --- ARABIC TEXT LOGIC ---
        const textElement = document.getElementById('arabic-overlay');
        
        function updateText() {
            if (state.handsDetected) {
                textElement.style.opacity = 0; // Hide when interacting
            } else {
                // Cycle text when idle
                const now = performance.now();
                if (now - state.lastPhraseTime > 4000) {
                    state.lastPhraseTime = now;
                    state.phraseIndex = (state.phraseIndex + 1) % ARABIC_PHRASES.length;
                    
                    // Fade out, swap, fade in
                    textElement.style.opacity = 0;
                    setTimeout(() => {
                        textElement.innerText = ARABIC_PHRASES[state.phraseIndex];
                        textElement.style.opacity = 1;
                    }, 1000);
                }
            }
        }

        // --- MEDIAPIPE HAND TRACKING ---
        const videoElement = document.getElementById('video-input');
        
        function onHandsResults(results) {
            document.getElementById('loader').style.display = 'none';

            if (results.multiHandLandmarks && results.multiHandLandmarks.length === 2) {
                state.handsDetected = true;

                const hand1 = results.multiHandLandmarks[0][9]; // Middle finger knuckle
                const hand2 = results.multiHandLandmarks[1][9];

                // 1. Map Coordinates (0-1) to World Space (-X to +X)
                // Note: Video is mirrored via CSS, but data matches original.
                // We create a viewing plane at Z=0.
                const aspect = window.innerWidth / window.innerHeight;
                const fovH = 2 * Math.tan((camera.fov * Math.PI / 180) / 2) * 12; // Distance 12
                const fovW = fovH * aspect;

                const h1x = (0.5 - hand1.x) * fovW; // Flip X
                const h1y = (0.5 - hand1.y) * fovH;
                const h2x = (0.5 - hand2.x) * fovW;
                const h2y = (0.5 - hand2.y) * fovH;

                // 2. Midpoint (Position)
                const targetX = (h1x + h2x) / 2;
                const targetY = (h1y + h2y) / 2;
                state.targetPos.set(targetX, targetY, 0);

                // 3. Distance (Scale)
                const dist = Math.sqrt(Math.pow(h2x - h1x, 2) + Math.pow(h2y - h1y, 2));
                // Map distance roughly 2 to 10 world units to scale
                const scaleNorm = THREE.MathUtils.mapLinear(dist, 2, 8, CONFIG.minScale, CONFIG.maxScale);
                state.targetScale = THREE.MathUtils.clamp(scaleNorm, CONFIG.minScale, CONFIG.maxScale);

                // 4. Angle (Rotation)
                const dy = h2y - h1y;
                const dx = h2x - h1x;
                // Add smooth steering logic
                state.targetRotZ = Math.atan2(dy, dx);

            } else {
                state.handsDetected = false;
            }
        }

        const hands = new Hands({locateFile: (file) => {
            return `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`;
        }});
        hands.setOptions({
            maxNumHands: 2,
            modelComplexity: 1,
            minDetectionConfidence: 0.5,
            minTrackingConfidence: 0.5
        });
        hands.onResults(onHandsResults);

        const cameraUtils = new Camera(videoElement, {
            onFrame: async () => { await hands.send({image: videoElement}); },
            width: 640,
            height: 480
        });
        cameraUtils.start();


        // --- ANIMATION LOOP ---
        function animate() {
            requestAnimationFrame(animate);
            
            updatePhysics();
            updateText();
            
            composer.render();
        }

        // --- RESIZE HANDLER ---
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
            composer.setSize(window.innerWidth, window.innerHeight);
        });

        // Start Text Loop
        textElement.innerText = ARABIC_PHRASES[0];
        textElement.style.opacity = 1;

        animate();

    </script>
</body>
</html>
